<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P≈ôidej Recept - Uva≈ôeno</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    
        <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D73VHD89XS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-D73VHD89XS');
    </script>

    <style>
        :root {
            --bg: #1A1A1D;
            --header: #121212;
            --accent: #A7C4C2;
            --btn-bg: #2C4251;
            --input-bg: #D9D9D9;
            --white: #ffffff;
        }
        
        body {
            background-color: var(--bg);
            color: var(--white);
            font-family: 'Inter', sans-serif;
        }

        .animate-entry { animation: fadeInUp 0.8s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUTY */
        .custom-input, .custom-select {
            background-color: var(--input-bg);
            color: #121212;
            border: 2px solid transparent;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-weight: 600;
            outline: none;
            transition: all 0.3s ease;
            height: 50px;
        }
        .custom-input:focus, .custom-select:focus {
            box-shadow: 0 0 0 4px rgba(167, 196, 194, 0.4);
            border-color: var(--accent);
        }

        /* SELECTY */
        .custom-select { appearance: none; cursor: pointer; }
        .select-wrapper { position: relative; width: 100%; }
        .select-arrow {
            position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);
            pointer-events: none; color: #121212; transition: transform 0.3s ease;
        }
        .custom-select:focus + .select-arrow { transform: translateY(-50%) rotate(180deg); }

        /* UPLOAD ZONE */
        .upload-zone {
            border: 2px dashed var(--accent);
            background-color: rgba(167, 196, 194, 0.05);
            transition: all 0.3s ease;
            min-height: 250px; /* Vƒõt≈°√≠ v√Ω≈°ka pro fotku */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .upload-zone:hover { background-color: rgba(167, 196, 194, 0.15); }

        /* BUTTON */
        .btn-custom {
            background-color: var(--btn-bg); color: var(--accent); font-weight: bold;
            transition: all 0.3s ease; border: 1px solid transparent;
        }
        .btn-custom:hover {
            background-color: var(--accent); color: var(--btn-bg); transform: translateY(-2px);
        }
        .btn-small {
            background-color: rgba(44, 66, 81, 0.5); color: var(--accent);
            border: 1px dashed var(--accent); transition: all 0.3s ease;
        }
        .btn-small:hover { background-color: var(--btn-bg); color: white; border-style: solid; }
    </style>

    <script>
        tailwind.config = { theme: { extend: { colors: { 'bg-primary': 'var(--bg)', 'accent': 'var(--accent)' } } } }
    </script>
</head>
<body class="bg-bg-primary min-h-screen flex flex-col">

    <nav class="bg-bg-header/90 backdrop-blur-md p-4 sticky top-0 z-50 border-b border-white/5 shadow-lg">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <a href="index.html" class="text-2xl md:text-3xl font-extrabold text-accent tracking-wider flex items-center gap-3 hover:text-white transition duration-300 no-underline">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-9 md:w-9" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13h13c0 3-2 6-6.5 6S3 16 3 13z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 13h6" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 7c.5-2-1.5-2-1.5-4M14 7c.5-2-1.5-2-1.5-4" />
                </svg>
                Uva≈ôeno
            </a>
            <div class="flex items-center space-x-4 md:space-x-8 text-sm md:text-base">
                <a href="index.html" class="text-white/80 hover:text-accent transition duration-300 font-medium no-underline">Dom≈Ø</a>
                <a href="recepty.html" class="text-accent font-bold transition duration-300 font-medium">Recepty</a>
                <a href="pridat-recept.html" class="text-white/80 hover:text-accent transition duration-300 font-medium no-underline">P≈ôidat Recept</a>
                
                <div class="relative">
                    <button onclick="handleUserIconClick()" class="flex items-center gap-2 text-accent hover:text-white transition focus:outline-none">
                        <div class="p-1 border-2 border-accent rounded-full hover:bg-white/10 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <span id="nav-username" class="font-bold hidden md:block text-sm"></span>
                    </button>

                    <div id="user-menu-content" class="hidden absolute right-0 mt-3 w-48 bg-[#1A1A1D] border border-white/10 rounded-xl shadow-2xl overflow-hidden z-50">
                        <div class="px-4 py-3 border-b border-white/5 bg-white/5">
                            <span class="block text-xs text-white/50 uppercase tracking-wider">P≈ôihl√°≈°en jako</span>
                            <span id="menu-username" class="block text-sm font-bold text-white truncate">User</span>
                        </div>
                        
                        <a id="nav-admin-link" href="admin.html" class="block px-4 py-2 text-sm text-yellow-500 hover:bg-white/5 hidden">üëë Admin Panel</a>
                        <a href="#" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/5 transition">üìñ Moje recepty</a>
                        <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-white/5 transition border-t border-white/5">Odhl√°sit se</a>
                    </div>
                </div>

            </div>
        </div>
    </nav>

    <main class="flex-grow flex items-center justify-center py-12 px-4">
        <div class="bg-[#121212] w-full max-w-3xl p-8 md:p-12 rounded-2xl shadow-2xl border border-white/5 relative form-container animate-entry">
            
            <h1 class="text-4xl font-bold text-center text-white mb-10">P≈ôidej recept</h1>

            <form id="recipeForm" class="space-y-6" onsubmit="event.preventDefault(); submitRecipe();">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <input type="text" id="nazev" placeholder="N√°zev receptu.." class="custom-input" required>
                    </div>
                    
                    <div class="select-wrapper">
                        <select id="kategorie" class="custom-select">
                            <option value="" disabled selected>Druh chodu</option>
                            <option value="pol√©vka">Pol√©vka</option>
                            <option value="hlavn√≠">Hlavn√≠ chod</option>
                            <option value="dezert">Dezert</option>
                        </select>
                        <div class="select-arrow">‚ñº</div>
                    </div>
                </div>

                <div>
                    <input type="text" id="popis" placeholder="Kr√°tk√Ω popis.." class="custom-input" required>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="select-wrapper">
                        <select id="obtiznost" class="custom-select">
                            <option value="" disabled selected>Obt√≠≈ænost</option>
                            <option value="snadn√°">Snadn√°</option>
                            <option value="st≈ôedn√≠">St≈ôedn√≠</option>
                            <option value="tƒõ≈æk√°">Tƒõ≈æk√°</option>
                        </select>
                        <div class="select-arrow">‚ñº</div>
                    </div>
                    
                    <div class="select-wrapper">
                        <select id="cas" class="custom-select">
                            <option value="" disabled selected>Doba p≈ô√≠pravy</option>
                            <option value="30">Do 30 min</option>
                            <option value="45">Do 45 min</option>
                            <option value="60">Do 1 hod</option>
                            <option value="90">Do 1.5 hod</option>
                            <option value="120">Nad 1.5 hod</option>
                        </select>
                        <div class="select-arrow">‚ñº</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    <div class="flex flex-col gap-4">
                        <div id="ingredients-container" class="flex flex-col gap-3">
                            <input type="text" placeholder="1. Ingredience" class="custom-input dynamic-ingredient">
                        </div>
                        <button type="button" onclick="addInput('ingredients-container', 'Ingredience', false, 'dynamic-ingredient')" class="btn-small py-3 rounded-md text-sm uppercase tracking-wider font-bold">+ P≈ôidej ingredienci</button>
                    </div>

                    <div class="flex flex-col gap-4">
                        <div id="steps-container" class="flex flex-col gap-3">
                            <textarea placeholder="1. Krok postupu" rows="1" class="custom-input resize-none overflow-hidden pt-3 dynamic-step" oninput="autoResize(this)"></textarea>
                        </div>
                        <button type="button" onclick="addInput('steps-container', 'Krok postupu', true, 'dynamic-step')" class="btn-small py-3 rounded-md text-sm uppercase tracking-wider font-bold">+ P≈ôidej dal≈°√≠ krok</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="select-wrapper">
                        <select id="maso" class="custom-select">
                            <option value="" disabled selected>Maso</option>
                            <option value="none">Bez masa</option>
                            <option value="kr≈Øt√≠">Kr≈Øt√≠</option>
                            <option value="hus√≠">Hus√≠</option>
                            <option value="kachn√≠">Kachn√≠</option>
                            <option value="hovƒõz√≠">Hovƒõz√≠</option>
                            <option value="vep≈ôov√©">Vep≈ôov√©</option>
                            <option value="jehnƒõƒç√≠">Jehnƒõƒç√≠</option>
                            <option value="zvƒõ≈ôina">Zvƒõ≈ôina</option>
                            <option value="mo≈ôsk√©">Mo≈ôsk√© plody</option>
                            <option value="ryby">Ryby</option>
                            <option value="uzeniny">Uzeniny</option>
                            <option value="vnit≈ônosti">Vnit≈ônosti</option>
                        </select>
                        <div class="select-arrow">‚ñº</div>
                    </div>
                    
                    <div class="select-wrapper">
                        <select id="pikantnost" class="custom-select">
                            <option value="" disabled selected>Pikantnost</option>
                            <option value="none">≈Ω√°dn√°</option>
                            <option value="mild">Jemnƒõ p√°liv√©</option>
                            <option value="hot">P√°liv√©</option>
                        </select>
                        <div class="select-arrow">‚ñº</div>
                    </div>
                </div>

                <div>
                    <input type="text" id="tip" placeholder="Tip ≈°√©fkucha≈ôe na z√°vƒõr" class="custom-input">
                </div>

                <div class="upload-zone relative rounded-xl cursor-pointer group">
                    <input type="file" id="obrazek" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewImage(this)">
                    
                    <div id="upload-placeholder" class="flex flex-col items-center justify-center gap-4 relative pointer-events-none text-center p-8">
                        <div class="p-5 bg-[#2C4251] rounded-full group-hover:scale-110 transition duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 upload-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9" transform="translate(6, -6)" />
                            </svg>
                        </div>
                        <p class="text-white font-mono text-lg tracking-wide mt-2">Klikni pro nahr√°n√≠ fotky</p>
                    </div>

                    <img id="image-preview" src="" class="absolute inset-0 w-full h-full object-cover hidden rounded-xl z-0">
                </div>

                <button type="submit" id="submit-btn" class="w-full btn-custom py-4 rounded-md uppercase tracking-widest text-lg shadow-lg transform hover:-translate-y-1 mt-8 block">
                    P≈òIDAT RECEPT
                </button>

            </form>
        </div>
    </main>

    <footer class="bg-bg-header py-6 text-center text-white/40 border-t border-white/5 text-sm">
        <p>&copy; 2025 Uva≈ôeno. Br√°≈°ko, tohle je top projekt.</p>
    </footer>

    <script>
        // --- 1. N√ÅHLED OBR√ÅZKU ---
        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const placeholder = document.getElementById('upload-placeholder');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden'); 
                    placeholder.classList.add('hidden'); 
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 2. DYNAMICK√â P≈òID√ÅV√ÅN√ç POL√ç ---
        function autoResize(textarea) {
            textarea.style.height = "auto";
            textarea.style.height = textarea.scrollHeight + "px";
        }

        function addInput(containerId, placeholder, isTextarea, className) {
            const container = document.getElementById(containerId);
            const count = container.children.length + 1;
            const wrapper = document.createElement('div');
            wrapper.className = "flex gap-2 items-start opacity-0"; 
            
            let newElement;
            if (isTextarea) {
                newElement = document.createElement('textarea');
                newElement.rows = 1;
                newElement.className = "custom-input resize-none overflow-hidden pt-3 " + className;
                newElement.oninput = function() { autoResize(this) };
            } else {
                newElement = document.createElement('input');
                newElement.type = "text";
                newElement.className = "custom-input " + className;
            }
            newElement.placeholder = `${count}. ${placeholder}`;

            const deleteBtn = document.createElement('button');
            deleteBtn.type = "button";
            deleteBtn.className = "mt-1 p-3 text-red-400 hover:bg-red-400/10 rounded-md transition";
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
            deleteBtn.onclick = () => wrapper.remove();

            wrapper.appendChild(newElement);
            wrapper.appendChild(deleteBtn);
            container.appendChild(wrapper);

            gsap.fromTo(wrapper, { height: 0, opacity: 0 }, { height: "auto", opacity: 1, duration: 0.4 });
        }

        // --- 3. VALIDACE A ODESL√ÅN√ç ---
        async function submitRecipe() {
            const btn = document.getElementById('submit-btn');
            
            // --- VALIDACE ---
            const requiredFields = ['nazev', 'popis', 'kategorie', 'obtiznost', 'cas', 'maso', 'pikantnost'];
            let isValid = true;
            let missingFields = [];

            requiredFields.forEach(fieldId => {
                const el = document.getElementById(fieldId);
                if (!el.value || el.value.trim() === "") {
                    isValid = false;
                    el.classList.add('border-red-500'); // Zv√Ωraznƒõn√≠ chyby (pokud m√°≈° border v CSS)
                    missingFields.push(fieldId);
                } else {
                    el.classList.remove('border-red-500');
                }
            });

            // Kontrola dynamick√Ωch pol√≠
            const ingredience = Array.from(document.querySelectorAll('.dynamic-ingredient'))
                                     .map(el => el.value).filter(val => val.trim() !== "");
            const postup = Array.from(document.querySelectorAll('.dynamic-step'))
                                .map(el => el.value).filter(val => val.trim() !== "");

            if (ingredience.length === 0) { isValid = false; alert("Mus√≠≈° p≈ôidat alespo≈à jednu ingredienci!"); return; }
            if (postup.length === 0) { isValid = false; alert("Mus√≠≈° napsat alespo≈à jeden krok postupu!"); return; }

            if (!isValid) {
                alert("Br√°≈°ko, zapomnƒõl jsi vyplnit v≈°echna pol√≠ƒçka! Zkontroluj to.");
                return; // Nepust√≠me to d√°l
            }

            // --- P≈ò√çPRAVA DAT ---
            btn.textContent = "Odes√≠l√°m...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('nazev', document.getElementById('nazev').value);
            formData.append('popis', document.getElementById('popis').value);
            formData.append('kategorie', document.getElementById('kategorie').value);
            formData.append('obtiznost', document.getElementById('obtiznost').value);
            formData.append('cas', document.getElementById('cas').value);
            formData.append('maso', document.getElementById('maso').value);
            formData.append('pikantnost', document.getElementById('pikantnost').value);
            formData.append('tip', document.getElementById('tip').value);
            
            formData.append('ingredience', JSON.stringify(ingredience));
            formData.append('postup', JSON.stringify(postup));

            // Obr√°zek (nepovinn√Ω)
            const imageFile = document.getElementById('obrazek').files[0];
            if (imageFile) {
                formData.append('obrazek', imageFile);
            }

            // --- ODESL√ÅN√ç ---
            try {
                const response = await fetch('/api/pridat-recept', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();

                if (result.success) {
                    alert("‚úÖ " + result.message);
                    window.location.href = "recepty.html"; 
                } else {
                    alert("‚ùå Chyba: " + result.message);
                    btn.textContent = "ZKUSIT ZNOVU";
                    btn.disabled = false;
                }
            } catch (error) {
                console.error(error);
                alert("‚ùå Chyba p≈ôipojen√≠ k serveru.");
                btn.textContent = "ZKUSIT ZNOVU";
                btn.disabled = false;
            }
        }
        
        // Animace p≈ô√≠letu
        window.addEventListener('load', () => {
            gsap.from(".form-container", { y: 50, opacity: 0, duration: 0.8, ease: "power3.out" });
        });
        // Glob√°ln√≠ promƒõnn√° pro stav p≈ôihl√°≈°en√≠
        let isUserLoggedIn = false;

        // --- 1. Zjistit stav p≈ôi naƒçten√≠ ---
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();

                const navUsername = document.getElementById('nav-username');
                const menuUsername = document.getElementById('menu-username');
                const adminLink = document.getElementById('nav-admin-link');

                if (data.logged_in) {
                    isUserLoggedIn = true;
                    
                    // Zobraz√≠me jm√©no vedle ikonky
                    if(navUsername) {
                        navUsername.textContent = data.jmeno;
                        navUsername.classList.remove('hidden'); 
                    }
                    if(menuUsername) menuUsername.textContent = data.jmeno;

                    // Pokud je admin, uk√°zat odkaz
                    if (data.role === 'admin' && adminLink) {
                        adminLink.classList.remove('hidden');
                    }
                } else {
                    isUserLoggedIn = false;
                    // Skryjeme jm√©no, nech√°me jen ikonku
                    if(navUsername) navUsername.classList.add('hidden');
                }
            } catch (error) {
                console.error("Chyba p≈ôi kontrole p≈ôihl√°≈°en√≠:", error);
            }
        }

        // --- 2. Co se stane po kliknut√≠ na pandul√°ka ---
        function handleUserIconClick() {
            if (isUserLoggedIn) {
                // Je p≈ôihl√°≈°en -> Otev≈ôi/Zav≈ôi menu
                toggleUserMenu();
            } else {
                // Nen√≠ p≈ôihl√°≈°en -> Jdi na login
                window.location.href = 'login.html';
            }
        }

        function toggleUserMenu() {
            const menu = document.getElementById('user-menu-content');
            menu.classList.toggle('hidden');
            
            if (!menu.classList.contains('hidden')) {
                gsap.fromTo(menu, { opacity: 0, y: -10 }, { opacity: 1, y: 0, duration: 0.2 });
            }
        }

        // Zav≈ô√≠t menu kliknut√≠m jinam
        window.addEventListener('click', function(e) {
            const menu = document.getElementById('user-menu-content');
            // Mus√≠me zkontrolovat, jestli neklik√°me na tlaƒç√≠tko s ikonkou
            const btn = document.querySelector('button[onclick="handleUserIconClick()"]');
            
            if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // --- 3. Odhl√°≈°en√≠ ---
        async function logout() {
            await fetch('/api/logout');
            window.location.href = "index.html"; 
        }

        window.addEventListener('load', () => {
            checkLoginStatus();
            // Zde p≈ô√≠padnƒõ dal≈°√≠ init funkce
        });
    </script>


</body>
</html>